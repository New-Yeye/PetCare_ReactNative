# MQTT 报文格式对接

## **（Phone ESP Server）（Pet/Topic{}）**

### 食物投喂：`Pet/*/Feed`
- **阈值修改**
  - P - `{'max': float}` -> 阈值设定 E
- **投喂量查询**
  - P - `''` -> 投喂量发送 S - `{'res':[{},...]}` -> 投喂量接收 P
- **投喂量确认保存**
  - P - `{'save': boolean}` -> 投喂量发送 E - `{'feedValue': float}` -> 投喂量存表 S

### 温湿度：`Pet/*/Env`
- **阈值修改**
  - P - `{'tMax': float, 'hMax': float}` -> 阈值设定 E
- **平均温湿度查询**
  - P - `''` -> 平均温湿度发送 S - `{'res':[{'t': float, 'h': float},...]}` -> 平均温湿度接收 P
- **每隔 2s 温湿度发送**
  - E - `{'t': float, 'h': float}` -> 温湿度存表 S

### 设备控制
- **报警开关状态发送**  
  - P - `{'open': boolean}` -> 设定 E (`Pet/*/Alarm`)
- **OLED：`Pet/*/OLED`**
  - 开关状态发送 P - `{'open': boolean}` -> 设定 E
  - 字体状态发送 P - `{'font': int}` -> 设定 E
  - 颜色状态发送 P - `{'color': boolean}` -> 设定 E
- **LED 灯：`Pet/*/LED`**
  - 开关状态发送 P - `{'open': boolean}` -> 设定 E
  - RGB 颜色修改数据发送 P - `{'r': int, 'g': int, 'b': int}` -> 设定 E
- **风扇：`Pet/*/Fan`**
  - 开关状态发送 P - `{'open': boolean}` -> 设定 E
  - 风力大小发送 P - `{'state': int}` -> 设定 E
- **蜂鸣器：`Pet/*/Buzzer`**
  - 开关状态发送 P - `{'open': boolean}` -> 设定 E

---

## **前后端功能**
### **Tab**
- **Stack**
  - `Screen`
- **MQTT 调试**
  - 连接
  - 订阅
  - 发布
- **食物投喂**
  - 阈值修改 ->  
  - -> 投喂量查询 ->  
  - 投喂量记录 ->  
- **温湿度**
  - 阈值修改 ->  
  - -> (平均)温湿度查询 ->  
- **设备控制**
  - 报警开关 ->  
  - OLED 屏
    - 开关 ->  
    - 显示字体 ->  
    - 显示颜色 ->  
  - LED 灯
    - 开关 ->  
    - RGB 颜色修改 ->  
  - 风扇
    - 开关 ->  
    - 风力修改 ->  
  - 蜂鸣器
    - 开关 ->  

---

## **硬件描述**
### **引脚配置**
- **OLED**
  - SCL: 22
  - SDA: 21
- **温湿度传感器 DHT11**: 15
- **LED 灯**
  - R: 5
  - G: 18
  - B: 19
- **称重传感器和 HX711**
  - DT: 16
  - SCK: 4
- **风扇 ST027**: 23
- **蜂鸣器**: 2

### **控制器状态变量**
- `T_L`: 温度阈值  
- `H_L`: 湿度阈值  
- `W_L`: 重量阈值  
- `AlarmSwitch`: 报警开关  

### **模块功能**
- **报警**
  - 食物或温湿度超过阈值
    - LED 显示红色
    - 蜂鸣器长响
    - OLED 显示报警原因：
      - 食物投喂超量！！！
      - 温度过高！！！
      - 湿度过高！！！
- **操作提示**
  - LED 闪烁
  - 蜂鸣器短响
- **食物投喂**
  - 设置阈值  
  - (平均)投喂量数据发送 ->  
  - 投喂量保存于数据库  
  - OLED 显示当前重量、还需投喂的量  
- **温湿度**
  - 设置阈值  
  - (平均)温湿度数据发送 ->  
  - OLED 显示温湿度  
  - 每 5s 更新平均值并记录到数据库 ->  
- **设备控制**
  - OLED 屏
    - 设置显示字体  
    - 设置显示颜色  
    - 设置开关  
  - LED 灯
    - 设置 RGB 颜色  
    - 设置开关  
  - 风扇
    - 设置风力  
    - 设置开关  
  - 蜂鸣器
    - 设置开关  

---

## **MQTT Broker 服务器**
- **华为云服务器**  
  - 搭载 Ubuntu 18.04
  - EMQX
  - MySQL 数据库  
  - [搭建教程](https://bbs.huaweicloud.com/blogs/435256)

### **EMQX 控制台操作**
- `sudo systemctl emqx start`    启动  
- `sudo systemctl emqx stop`     停止  
- `sudo systemctl emqx restart`  重启  
